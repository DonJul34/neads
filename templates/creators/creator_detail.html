{% extends 'base.html' %}

{% block title %}
    {% if user.role == 'client' %}
        {{ creator.first_name }} {{ creator.last_name|first }}. - NEADS
    {% else %}
        {{ creator.full_name }} - NEADS
    {% endif %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" />
<style>
  .creator-header {
    background-color: var(--light-bg);
    border-radius: 0.5rem;
    padding: 2rem;
  }
  .card {
    height:auto;
  }
  .creator-profile-pic {
    width: 200px;
    height: 200px;
    object-fit: cover;
    border-radius: 50%;
    border: 4px solid white;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .creator-stats {
    background-color: white;
    border-radius: 0.5rem;
    padding: 1.5rem;
  }

  .domain-badge {
    display: inline-block;
    padding: 0.35em 0.65em;
    border-radius: 0.25rem;
    background-color: var(--light-bg);
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
  }

  .star-rating {
    color: var(--accent-color);
    font-size: 1.25rem;
  }

  .contact-item {
    display: flex;
    align-items: center;
    margin-bottom: 0.75rem;
  }

  .contact-item i {
    width: 24px;
    margin-right: 0.75rem;
    color: var(--primary-color);
  }

  .media-gallery {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1rem;
  }

  .media-item {
    border-radius: 0.5rem;
    overflow: hidden;
    position: relative;
    cursor: pointer;
    transition: transform 0.2s ease;
  }

  .media-item:hover {
    transform: scale(1.05);
  }

  .media-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .media-item.phone-format {
    aspect-ratio: 9/16;
  }

  .media-item .play-icon {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 3rem;
    color: white;
    text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
  }

  .bio-section {
    border-left: 3px solid var(--primary-color);
    padding-left: 1rem;
    font-style: italic;
  }

  .rating-progress {
    height: 12px;
  }

  .rating-bar {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
  }

  .rating-label {
    width: 50px;
  }

  .progress {
    flex: 1;
  }

  .rating-percent {
    width: 50px;
    text-align: right;
  }

  .video-container {
    border-radius: 0.5rem;
    overflow: hidden;
    position: relative;
    padding-top: 56.25%;
    /* 16:9 Aspect Ratio */
  }

  .video-container video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }

  #creator-map {
    height: 300px;
    width: 100%;
    border-radius: 0.5rem;
  }

  .verified-badge {
    position: absolute;
    top: 15px;
    right: 15px;
    background-color: var(--primary-color);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.8rem;
  }

  /* Styles pour la notation interactive */
  .interactive-stars {
    display: flex;
    align-items: center;
  }

  .interactive-stars .fa-star {
    transition: color 0.2s ease, transform 0.1s ease;
  }

  .interactive-stars .fa-star:hover {
    transform: scale(1.2);
  }

  .interactive-stars .fa-star.active {
    color: #ffc107 !important;
  }

  .selected-rating {
    font-weight: bold;
    color: #495057;
    transition: color 0.2s ease;
  }

  #comment-textarea {
    border: 1px solid #ced4da;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
  }

  #comment-textarea:focus {
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
  }

  #mediaModalContent video {
    max-height: 80vh;
  }
  
  /* New styles for left sidebar */
  .sidebar-card {
    margin-bottom: 1.5rem;
  }
  
  .tagline {
    font-style: italic;
    color: #6c757d;
    margin-bottom: 1rem;
  }
  
  .social-links a {
    display: inline-block;
    margin-right: 0.5rem;
    color: #495057;
    font-size: 1.25rem;
  }
  
  .central-content {
    max-width: 800px;
    margin: 0 auto;
  }
</style>
{% endblock %}

{% block content %}
<!-- Main content container -->
<div class="container">
  <!-- Creator header section -->
  <div class="creator-header position-relative mb-4">
    <!-- Panneau d'administration pour les admins et créateurs -->
    {% if user.is_authenticated %}
    {% if user.role == 'admin' %}
    <div class="admin-panel position-absolute top-0 end-0 p-3 bg-light border rounded shadow-sm"
      style="z-index: 999; margin-top: 50px">
      <h6 class="fw-bold mb-2">Actions d'administration</h6>
    </div>
    <div class="admin-panel position-absolute top-0 end-0 p-3 bg-light border rounded shadow-sm"
      style="z-index: 999; margin-top: 50px">
      <h6 class="fw-bold mb-2">Gérer mon profil</h6>
      <div class="btn-group-vertical w-100">
        <a href="{% url 'creator_edit' creator.id %}" class="btn btn-sm btn-outline-primary mb-1">
          <i class="fas fa-edit me-1"></i> Modifier mon profil
        </a>
        <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal"
          data-bs-target="#deleteCreatorModal">
          <i class="fas fa-trash-alt me-1"></i> Supprimer mon profil
        </button>
      </div>
    </div>
    {% endif %}
    {% endif %}

    <div class="row align-items-center">
      <div class="col-md-3 text-center">
        {% if creator.media.filter.first %}
        {% with media=creator.media.filter.first %}
        {% if media.file and media.file.name and media.file.url %}
        <img src="{{ media.file.url }}" alt="{{ creator.full_name }}" class="creator-profile-pic mb-3" />
        {% else %}
        <div
          class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center mx-auto creator-profile-pic mb-3">
          {{ creator.first_name|first|upper }}{{ creator.last_name|first|upper }}
        </div>
        {% endif %}
        {% endwith %}
        {% else %}
        <div
          class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center mx-auto creator-profile-pic mb-3">
          {{ creator.first_name|first|upper }}{{ creator.last_name|first|upper }}
        </div>
        {% endif %}
      </div>

      <div class="col-md-9">
        <h1 class="h2 mb-1">
          {% if user.role == 'client' %}
            {{ creator.first_name }} {{ creator.last_name|first }}.
          {% else %}
            {{ creator.full_name }}
          {% endif %}
        </h1>
        
        {% if creator.baseline %}
        <p class="tagline">{{ creator.baseline }}</p>
        {% endif %}
        
        <p class="text-muted mb-2">
          {{ creator.age }} ans, {{ creator.get_gender_display }}
        </p>

        <div class="star-rating mb-2">
          {% for i in "12345" %} {% if forloop.counter <= creator.average_rating %} <i class="fas fa-star"></i>
            {% elif forloop.counter <= creator.average_rating|add:0.5 %} <i class="fas fa-star-half-alt"></i>
              {% else %}
              <i class="far fa-star"></i>
              {% endif %} {% endfor %}
              <span class="ms-2 text-muted">({{ creator.average_rating }} - {{ creator.total_ratings }}
                avis)</span>
        </div>

<!-- Boutons d'actions -->
<div class="d-flex flex-wrap">
  {% if user.is_authenticated %}
    {% if user.role != 'client' %}
      <form method="post" action="{% url 'toggle_favorite' creator.id %}" class="me-2 mb-2">
        {% csrf_token %}
        {% if is_favorite %}
          <input type="hidden" name="action" value="remove" />
          <button type="submit" class="btn btn-outline-danger">
            <i class="fas fa-heart me-1"></i> Retirer des favoris
          </button>
          {% elif user.role == 'admin' or user.role == 'creator' and user.creator_profile and user.creator_profile.id != creator.id %}
          <button type="submit" class="btn btn-outline-primary">
            <i class="far fa-heart me-1"></i> Ajouter aux favoris
          </button>
      </form>

      <button type="button" class="btn btn-primary mb-2" data-bs-toggle="modal" data-bs-target="#contactModal">
        <i class="fas fa-envelope me-1"></i> Contacter
      </button>
      {% endif %}
    {% endif %}
  {% endif %}
</div>
      </div>
    </div>
  </div>

    <!-- Main row with two columns -->
    <div class="row">
      <!-- Left column (col-lg-4) with sidebar content -->
      <div class="col-lg-4">
        <!-- Section Info -->
        <div class="card border-0 shadow-sm sidebar-card">
          <div class="card-body p-4">
            <h2 class="h4 mb-3">Info</h2>
            <ul class="list-unstyled">
              {% if creator.location %}
              <li class="mb-2">
                <i class="fas fa-map-marker-alt me-2 text-primary"></i>
                {{ creator.location }}
              </li>
              {% endif %}
              <li class="mb-2">
                <i class="fas fa-user me-2 text-primary"></i>
                {{ creator.age }} ans, {{ creator.get_gender_display }}
              </li>
              {% if creator.equipment %}
              <li class="mb-2">
                <i class="fas fa-camera me-2 text-primary"></i>
                {{ creator.equipment }}
              </li>
              {% endif %}
              {% if creator.delivery_time %}
              <li class="mb-2">
                <i class="fas fa-clock me-2 text-primary"></i>
                {{ creator.delivery_time }}
              </li>
              {% endif %}
            </ul>
          </div>
        </div>
  
        <!-- Section Domaines -->
        <div class="card border-0 shadow-sm sidebar-card">
          <div class="card-body p-4">
            <h2 class="h4 mb-3">Domaines</h2>
            <div class="d-flex flex-wrap">
              {% for domain in creator.domains.all %}
              <span class="domain-badge">{{ domain.name }}</span>
              {% endfor %}
            </div>
          </div>
        </div>
  
        <!-- Section Réseaux sociaux -->
        {% if creator.social_links %}
        <div class="card border-0 shadow-sm sidebar-card">
          <div class="card-body p-4">
            <h2 class="h4 mb-3">Réseaux sociaux</h2>
            <div class="social-links">
              {% if creator.social_links.instagram %}
              <a href="{{ creator.social_links.instagram }}" target="_blank"><i class="fab fa-instagram"></i></a>
              {% endif %}
              {% if creator.social_links.facebook %}
              <a href="{{ creator.social_links.facebook }}" target="_blank"><i class="fab fa-facebook"></i></a>
              {% endif %}
              {% if creator.social_links.twitter %}
              <a href="{{ creator.social_links.twitter }}" target="_blank"><i class="fab fa-twitter"></i></a>
              {% endif %}
              {% if creator.social_links.tiktok %}
              <a href="{{ creator.social_links.tiktok }}" target="_blank"><i class="fab fa-tiktok"></i></a>
              {% endif %}
              {% if creator.social_links.youtube %}
              <a href="{{ creator.social_links.youtube }}" target="_blank"><i class="fab fa-youtube"></i></a>
              {% endif %}
            </div>
          </div>
        </div>
        {% endif %}
  
        <!-- Section Clients -->
        {% if creator.previous_clients %}
        <div class="card border-0 shadow-sm sidebar-card">
          <div class="card-body p-4">
            <h2 class="h4 mb-3">Clients</h2>
            <p>{{ creator.previous_clients }}</p>
          </div>
        </div>
        {% endif %}
  
        <!-- Section Localisation -->
        {% if creator.location and creator.location.latitude and creator.location.longitude %}
        <div class="card border-0 shadow-sm sidebar-card">
          <div class="card-body p-4">
            <h2 class="h4 mb-3">Localisation</h2>
            <div id="creator-map"></div>
          </div>
        </div>
        {% endif %}
      </div>

    <!-- Right column (col-lg-8) with main content -->
    <div class="col-lg-8">
      <!-- Central content container -->
      <div class="central-content">
        <!-- Section À propos -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-body p-4">
            <h2 class="h4 mb-3">À propos</h2>

            {% if creator.bio %}
            <div class="bio-section mb-4">
              <p>{{ creator.bio }}</p>
            </div>
            {% endif %}

            <div class="row">
              <div class="col-md-6">
                <h3 class="h5 mb-3">Setup & Professionnalisme</h3>
                <ul class="list-unstyled">
                  {% if creator.equipment %}
                  <li class="mb-2">
                    <i class="fas fa-camera me-2 text-primary"></i>
                    Matériel : {{ creator.equipment }}
                  </li>
                  {% endif %} {% if creator.delivery_time %}
                  <li class="mb-2">
                    <i class="fas fa-clock me-2 text-primary"></i>
                    Délai de livraison : {{ creator.delivery_time }}
                  </li>
                  {% endif %}
                  <li class="mb-2">
                    <i class="fas fa-car me-2 text-primary"></i>
                    Mobilité : {% if creator.mobility %}Oui (déplacements pris en
                    charge){% else %}Non{% endif %}
                  </li>
                </ul>
              </div>

              <div class="col-md-6">
                <h3 class="h5 mb-3">Facturation & Projets</h3>
                <ul class="list-unstyled">
                  <li class="mb-2">
                    <i class="fas fa-file-invoice-dollar me-2 text-primary"></i>
                    Statut : {% if creator.can_invoice %}<span class="text-success">✓ Peut facturer</span>{% else %}<span
                      class="text-danger">✗ Ne peut pas facturer</span>{% endif %}
                  </li>

                  {% if creator.previous_clients %}
                  <li class="mb-2">
                    <i class="fas fa-briefcase me-2 text-primary"></i>
                    Clients précédents : {{ creator.previous_clients }}
                  </li>
                  {% endif %}
                </ul>
              </div>
            </div>
          </div>
        </div>

        <!-- Section Portfolio Combiné - Images & Vidéos -->
        {% if photos or videos %}
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-body p-4">
            <h2 class="h4 mb-3">
              Portfolio ({{ photos|length|add:videos|length }}/20)
            </h2>

            <div class="media-gallery">
              {% for image in photos %}
              <div class="media-item phone-format" data-bs-toggle="modal" data-bs-target="#mediaModal"
                data-media-type="image" data-media-src="{% if image.file %}{{ image.file.url }}{% endif %}"
                data-media-title="{{ image.title|default:'Image' }}">
                {% if image.file and image.file.url %}
                  <img src="{{ image.file.url }}" alt="{{ image.title|default:'Image' }}" loading="lazy" 
                    onerror="this.onerror=null;this.src='data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22180%22%20height%3D%22320%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20180%20320%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_16a0ba36f21%20text%20%7B%20fill%3A%23999%3Bfont-weight%3Anormal%3Bfont-family%3AArial%2C%20Helvetica%2C%20sans-serif%3Bfont-size%3A16pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_16a0ba36f21%22%3E%3Crect%20width%3D%22180%22%20height%3D%22320%22%20fill%3D%22%23E2E3E5%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%2260.734375%22%20y%3D%22167.1%22%3EImage%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E';this.classList.add('broken-image');" />
                {% else %}
                  <div class="broken-image d-flex align-items-center justify-content-center h-100 bg-light">
                    <i class="fas fa-image fa-2x text-muted"></i>
                  </div>
                {% endif %}
              </div>
              {% endfor %} 
              {% for video in videos %}
              <div class="media-item phone-format video" data-bs-toggle="modal" data-bs-target="#mediaModal"
                data-media-type="video" 
                data-media-src="{% if video.video_file %}{{ video.video_file.url }}{% endif %}"
                data-media-title="{{ video.title|default:'Vidéo' }}" 
                data-media-poster="{% if video.thumbnail %}{{ video.thumbnail.url }}{% endif %}">
                {% if video.thumbnail and video.thumbnail.url %}
                  <img src="{{ video.thumbnail.url }}" alt="{{ video.title|default:'Vidéo' }}" loading="lazy"
                    onerror="this.onerror=null;this.src='data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22180%22%20height%3D%22320%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20180%20320%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_16a0ba36f21%20text%20%7B%20fill%3A%23999%3Bfont-weight%3Anormal%3Bfont-family%3AArial%2C%20Helvetica%2C%20sans-serif%3Bfont-size%3A16pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_16a0ba36f21%22%3E%3Crect%20width%3D%22180%22%20height%3D%22320%22%20fill%3D%22%23E2E3E5%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%2260.734375%22%20y%3D%22167.1%22%3EVidéo%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E';this.classList.add('broken-image');" />
                {% else %}
                  <div class="broken-image d-flex align-items-center justify-content-center h-100 bg-light">
                    <i class="fas fa-video fa-2x text-muted"></i>
                  </div>
                {% endif %}
                <div class="play-icon"><i class="fas fa-play-circle"></i></div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
        {% endif %}

        <!-- Section Avis & Notations -->
        {% if user.role == 'admin' or user.role == 'creator' and user.creator_profile and user.creator_profile.id != creator.id %}
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-body p-4">
            <h2 class="h4 mb-4">Avis & Notation</h2>

            <div class="row mb-4">
              <div class="col-md-4 text-center">
                <div class="h1 mb-0">{{ creator.average_rating }}</div>
                <div class="star-rating mb-2">
                  {% for i in "12345" %} {% if forloop.counter <= creator.average_rating %} <i class="fas fa-star"></i>
                    {% elif forloop.counter <= creator.average_rating|add:0.5 %} <i class="fas fa-star-half-alt"></i>
                      {% else %}
                      <i class="far fa-star"></i>
                      {% endif %} {% endfor %}
                </div>
                <div class="text-muted">{{ creator.total_ratings }} avis</div>
              </div>

              <div class="col-md-8">
                <div class="rating-breakdown">
                  {% for rating, count in rating_breakdown.items reversed %}
                  <div class="rating-bar">
                    <div class="rating-label">
                      {{ rating }} <i class="fas fa-star small"></i>
                    </div>
                    <div class="progress rating-progress">
                      {% if creator.total_ratings > 0 %}
                      <div class="progress-bar bg-warning" role="progressbar"
                        style="width: {{ count|floatformat:0|divisibleby:creator.total_ratings|floatformat:2|stringformat:"
                        f"|slice:"2:-1" }}%"
                        aria-valuenow="{{ count|floatformat:0|divisibleby:creator.total_ratings|floatformat:2|stringformat:"
                        f"|slice:"2:-1" }}" aria-valuemin="0" aria-valuemax="100">
                      </div>
                      {% else %}
                      <div class="progress-bar bg-warning" role="progressbar" style="width: 0%" aria-valuenow="0"
                        aria-valuemin="0" aria-valuemax="100"></div>
                      {% endif %}
                    </div>
                    <div class="rating-percent">{{ count }}</div>
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>

            <!-- Formulaire de notation avec étoiles interactives -->
            {% if user.is_authenticated %}
            {% if user.role == 'consultant' or user.role == 'admin' %}
            <div class="card bg-light mb-4">
              <div class="card-body">
                <h3 class="h5 mb-3">
                  {% if user_rating %}Modifier votre avis{% else %}Laisser un avis{% endif %}
                </h3>

                <form method="post" action="{% url 'rate_creator' creator.id %}">
                  {% csrf_token %}

                  <div class="mb-4">
                    <label class="form-label fw-bold">Votre note :</label>
                    <div class="star-rating-input d-flex align-items-center">
                      <div class="interactive-stars me-3" id="star-rating">
                        {% for i in "12345" %}
                        <i class="fas fa-star fs-2 {% if user_rating and forloop.counter <= user_rating.rating %}active{% endif %}"
                          data-rating="{{ forloop.counter }}" style="cursor: pointer; color: #ccc; margin-right: 5px"></i>
                        {% endfor %}
                      </div>
                      <span class="selected-rating fs-4" id="rating-value">
                        {% if user_rating %}{{ user_rating.rating }}{% else %}0{% endif %}/5
                      </span>
                      <input type="hidden" name="rating" id="rating-input"
                        value="{% if user_rating %}{{ user_rating.rating }}{% endif %}" />
                    </div>
                  </div>

                  <div class="mb-3">
                    <label for="comment-textarea" class="form-label fw-bold">Votre commentaire :</label>
                    <textarea id="comment-textarea" name="comment" class="form-control" rows="4"
                      placeholder="Partagez votre expérience avec ce créateur...">{% if user_rating %}{{ user_rating.comment }}{% endif %}</textarea>
                  </div>

                  <div class="mb-4">
                    <div class="form-check">
                      <input type="checkbox" class="form-check-input" name="has_experience" id="has-experience-checkbox"
                        {% if user_rating and user_rating.has_experience %}checked{% endif %} required />
                      <label class="form-check-label" for="has-experience-checkbox">
                        J'ai déjà travaillé avec ce créateur
                      </label>
                      <div class="alert alert-info mt-2">
                        <i class="fas fa-info-circle"></i> En cochant cette case,
                        vous confirmez avoir eu une expérience professionnelle avec
                        ce créateur. Votre avis sera publié immédiatement et visible
                        par tous les utilisateurs.
                      </div>
                    </div>
                  </div>

                  <div class="d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary" id="submit-rating" {% if not user_rating %}disabled{%
                      endif %}>
                      {% if user_rating %}Mettre à jour mon avis{% else %}Envoyer mon avis{% endif %}
                    </button>
                  </div>
                </form>
              </div>
            </div>
            {% elif user.role == 'client' %}
            <div class="alert alert-info mb-4">
              <i class="fas fa-info-circle me-2"></i>
              En tant que client, vous ne pouvez pas noter les créateurs.
              Veuillez contacter un consultant si vous souhaitez partager votre expérience avec ce créateur.
            </div>
            {% endif %}
            {% endif %}

            <!-- Affichage des avis -->
            {% if ratings %}
            <h3 class="h5 mb-3">Avis des clients</h3>

            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Utilisateur</th>
                    <th>Note</th>
                    <th>Commentaire</th>
                    <th>Date</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for rating in ratings %}
                  <tr>
                    <td>
                      {{ rating.user.get_full_name|default:rating.user.email }}
                    </td>
                    <td>
                      {% for i in "12345" %} {% if forloop.counter <= rating.rating %} <i
                        class="fas fa-star text-warning">
                        </i>
                        {% else %}
                        <i class="far fa-star"></i>
                        {% endif %} {% endfor %} ({{ rating.rating }})
                    </td>
                    <td>{{ rating.comment|default:"Pas de commentaire" }}</td>
                    <td>{{ rating.created_at|date:"d/m/Y" }}</td>
                    <td>
                      <div class="d-flex align-items-center">
                        {% if rating.has_experience %}
                        <span class="badge bg-success me-2"
                          title="L'utilisateur déclare avoir travaillé avec ce créateur">Expérience confirmée</span>
                        {% endif %} {% if is_admin %}
                        <button class="btn btn-sm btn-danger" data-bs-toggle="modal"
                          data-bs-target="#deleteRatingModal-{{ rating.id }}">
                          <i class="fas fa-trash"></i>
                        </button>

                        <!-- Modal de suppression -->
                        <div class="modal fade" id="deleteRatingModal-{{ rating.id }}" tabindex="-1" aria-hidden="true">
                          <div class="modal-dialog">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h5 class="modal-title">Supprimer cet avis</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                  aria-label="Close"></button>
                              </div>
                              <form action="{% url 'delete_rating' rating.id %}" method="post">
                                {% csrf_token %}
                                <div class="modal-body">
                                  <p>
                                    Êtes-vous sûr de vouloir supprimer l'avis de
                                    <strong>{{
                                      rating.user.get_full_name|default:rating.user.email
                                      }}</strong>
                                    ?
                                  </p>

                                  <div class="mb-3">
                                    <label for="reason-{{ rating.id }}" class="form-label">Raison de la suppression
                                      :</label>
                                    <select name="reason" id="reason-{{ rating.id }}" class="form-select">
                                      <option value="Avis sans expérience réelle">
                                        Avis sans expérience réelle
                                      </option>
                                      <option value="Contenu inapproprié">
                                        Contenu inapproprié
                                      </option>
                                      <option value="Avis trompeur ou faux">
                                        Avis trompeur ou faux
                                      </option>
                                      <option value="À la demande du créateur">
                                        À la demande du créateur
                                      </option>
                                      <option value="Autre">Autre</option>
                                    </select>
                                  </div>
                                </div>
                                <div class="modal-footer">
                                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    Annuler
                                  </button>
                                  <button type="submit" class="btn btn-danger">
                                    Supprimer
                                  </button>
                                </div>
                              </form>
                            </div>
                          </div>
                        </div>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <div class="alert alert-light text-center">
              Aucun avis pour le moment.
            </div>
            {% endif %}
          </div>
      </div>
    </div>
    {% endif %}


  <!-- Modals section -->
  <!-- Delete modal -->
  {% if user.is_authenticated %}
  <div class="modal fade" id="deleteCreatorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Supprimer le profil</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Attention ! Cette action est irréversible.
          </div>
          <p>Êtes-vous absolument sûr de vouloir supprimer ce profil ?</p>
          <ul>
            <li>Toutes les informations du profil</li>
            <li>Toutes les images et vidéos</li>
            <li>Tous les avis associés</li>
          </ul>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <form method="post" action="{% url 'creator_delete' creator.id %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">Supprimer définitivement</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  {% endif %}

  <!-- Media modal -->
  <div class="modal fade" id="mediaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="mediaModalTitle"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="mediaModalContent"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Contact Modal -->
  <div class="modal fade" id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="contactModalLabel">
            Contacter {% if user.role == 'client' %}{{ creator.first_name }} {{ creator.last_name|first }}.{% else %}{{ creator.get_full_name }}{% endif %}
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="contactForm" method="post" action="{% url 'contact_creator' creator.id %}">
          {% csrf_token %}
          <div class="modal-body">
            <div class="mb-3">
              <label for="subject" class="form-label">Sujet</label>
              <input type="text" class="form-control" id="subject" name="subject" required>
            </div>
            <div class="mb-3">
              <label for="message" class="form-label">Message</label>
              <textarea class="form-control" id="message" name="message" rows="5" required></textarea>
            </div>
            <div class="mb-3 form-check">
              <input type="checkbox" class="form-check-input" id="copy_me" name="copy_me">
              <label class="form-check-label" for="copy_me">M'envoyer une copie du message</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            <button type="submit" class="btn btn-primary">Envoyer</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
{% if creator.location and creator.location.latitude and creator.location.longitude %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Attendre que le DOM soit complètement chargé
    setTimeout(function() {
      try {
        // Vérifier si l'élément de carte existe
        const mapElement = document.getElementById('creator-map');
        if (!mapElement) {
          console.error("L'élément #creator-map est introuvable");
          return;
        }
        
        // S'assurer que le conteneur est visible et dimensionné correctement
        mapElement.style.display = 'block';
        mapElement.style.height = '300px';
        mapElement.style.width = '100%';
        mapElement.style.backgroundColor = '#f8f9fa';
        
        // Vérifier que les coordonnées sont valides
        const lat = parseFloat("{{ creator.location.latitude }}");
        const lng = parseFloat("{{ creator.location.longitude }}");
        
        if (isNaN(lat) || isNaN(lng)) {
          console.error("Coordonnées invalides:", lat, lng);
          mapElement.innerHTML = "<div class='alert alert-warning'>Localisation invalide</div>";
          return;
        }
        
        // Initialisation de la carte Leaflet
        var map = L.map('creator-map').setView([lat, lng], 13);
        
        // Utiliser setTimeout pour résoudre les problèmes de rendu
        setTimeout(() => {
          map.invalidateSize();
          
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
          }).addTo(map);
      
          // Marqueur pour le créateur
          L.marker([lat, lng])
            .addTo(map)
            .bindPopup({% if user.role == 'client' %}'{{ creator.first_name }} {{ creator.last_name|first }}.'{% else %}'{{ creator.full_name }}'{% endif %});
        }, 100);
      } catch (e) {
        console.error("Erreur lors de l'initialisation de la carte:", e);
      }
    }, 500); // Attendre 500ms pour s'assurer que le DOM est prêt
  });

  // Fonction pour télécharger la VCard
  function downloadVCard() {
    // Code pour générer une VCard
    var vcard = 'BEGIN:VCARD\n';
    vcard += 'VERSION:3.0\n';
    vcard += 'FN:{{ creator.full_name }}\n';
    vcard += 'EMAIL:{{ creator.email }}\n';
    {% if creator.phone %}
    vcard += 'TEL:{{ creator.phone }}\n';
    {% endif %}
    {% if creator.location %}
    vcard += 'ADR:;;{{ creator.location }}\n';
    {% endif %}
    vcard += 'END:VCARD';

    // Création d'un élément <a> pour le téléchargement
    var element = document.createElement('a');
    element.setAttribute('href', 'data:text/vcard;charset=utf-8,' + encodeURIComponent(vcard));
    element.setAttribute('download', '{% if user.role == 'client' %}{{ creator.first_name }} {{ creator.last_name|first }}.{% else %}{{ creator.full_name }}{% endif %}.vcf');
    element.style.display = 'none';
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
  }
</script>
{% endif %}

<!-- Script pour gérer les étoiles interactives de notation -->
{% if user.is_authenticated %}
{% if user.role == 'consultant' or user.role == 'admin' %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const stars = document.querySelectorAll("#star-rating .fa-star");
    const ratingInput = document.getElementById("rating-input");
    const ratingValue = document.getElementById("rating-value");
    const submitButton = document.getElementById("submit-rating");
    const hasExperienceCheckbox = document.getElementById("has-experience-checkbox");

    // Fonction pour mettre à jour l'affichage des étoiles
    function updateStars(rating) {
      stars.forEach((star, index) => {
        if (index < rating) {
          star.style.color = "#ffc107"; // Jaune Bootstrap
          star.classList.add("active");
        } else {
          star.style.color = "#ccc";
          star.classList.remove("active");
        }
      });

      // Mettre à jour le texte et l'input hidden
      ratingValue.textContent = rating + "/5";
      ratingInput.value = rating;

      // Activer/désactiver le bouton d'envoi
      submitButton.disabled = rating === 0;
    }

    // Gérer les clics sur les étoiles
    stars.forEach((star) => {
      // Au survol
      star.addEventListener("mouseenter", function () {
        const rating = parseInt(this.getAttribute("data-rating"));
        stars.forEach((s, index) => {
          if (index < rating) {
            s.style.color = "#ffc107";
          }
        });
      });

      // Sortie du survol
      star.addEventListener("mouseleave", function () {
        const currentRating = parseInt(ratingInput.value) || 0;
        stars.forEach((s, index) => {
          if (!s.classList.contains("active")) {
            s.style.color = "#ccc";
          }
        });
      });

      // Au clic
      star.addEventListener("click", function () {
        const rating = parseInt(this.getAttribute("data-rating"));
        updateStars(rating);
      });
    });

    // Initialiser l'affichage des étoiles
    const initialRating = parseInt(ratingInput.value) || 0;
    updateStars(initialRating);

    // Gérer le changement de la case à cocher
    hasExperienceCheckbox.addEventListener("change", function () {
      if (!ratingInput.value || ratingInput.value === "0") {
        submitButton.disabled = true;
      } else {
        submitButton.disabled = !this.checked;
      }
    });
  });
</script>
{% endif %}
{% endif %}

<!-- Script pour gérer le modal des médias -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const mediaModal = document.getElementById("mediaModal");
    if (mediaModal) {
      mediaModal.addEventListener("show.bs.modal", function (event) {
        try {
          const button = event.relatedTarget;
          const mediaType = button.getAttribute("data-media-type");
          const mediaSrc = button.getAttribute("data-media-src");
          const mediaTitle = button.getAttribute("data-media-title");
          const mediaPoster = button.getAttribute("data-media-poster");

          const modalTitle = document.getElementById("mediaModalTitle");
          const modalContent = document.getElementById("mediaModalContent");

          // Vérifier si les sources sont valides
          if (!mediaSrc) {
            console.error("Source média manquante pour:", mediaTitle);
            modalTitle.textContent = "Erreur de chargement";
            modalContent.innerHTML = `
              <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Le fichier média n'a pas pu être chargé.
              </div>
            `;
            return;
          }

          modalTitle.textContent = mediaTitle;

          if (mediaType === "image") {
            modalContent.innerHTML = `<img src="${mediaSrc}" class="img-fluid" alt="${mediaTitle}" onerror="this.onerror=null;this.src='data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22800%22%20height%3D%22400%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20800%20400%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_16a0ba36f21%20text%20%7B%20fill%3A%23999%3Bfont-weight%3Anormal%3Bfont-family%3AArial%2C%20Helvetica%2C%20sans-serif%3Bfont-size%3A40pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_16a0ba36f21%22%3E%3Crect%20width%3D%22800%22%20height%3D%22400%22%20fill%3D%22%23E2E3E5%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%22247.3125%22%20y%3D%22217.7%22%3EImage%20non%20disponible%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E';">`;
          } else if (mediaType === "video") {
            // Vérifier si la miniature existe
            const posterAttr = mediaPoster ? `poster="${mediaPoster}"` : '';
            
            modalContent.innerHTML = `
              <video controls class="img-fluid" ${posterAttr}>
                <source src="${mediaSrc}" type="video/mp4">
                Votre navigateur ne supporte pas la lecture vidéo.
              </video>
            `;

            // Auto-play video when modal opens
            const video = modalContent.querySelector("video");
            if (video) {
              video.play().catch(e => {
                console.warn("Impossible de lire automatiquement la vidéo:", e);
              });
            }
          }
        } catch (e) {
          console.error("Erreur lors de l'affichage du modal:", e);
          modalContent.innerHTML = `
            <div class="alert alert-danger">
              <i class="fas fa-exclamation-circle me-2"></i>
              Une erreur est survenue lors du chargement du média.
            </div>
          `;
        }
      });

      // Stop video playback when modal is closed
      mediaModal.addEventListener("hidden.bs.modal", function () {
        const video = document.querySelector("#mediaModalContent video");
        if (video) {
          video.pause();
          // Réinitialiser la source pour libérer les ressources
          video.src = "";
          video.load();
        }
      });
    }
  });
</script>
{% endblock %}