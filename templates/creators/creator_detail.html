{% extends 'base.html' %}

{% block title %}{{ creator.full_name }} - NEADS{% endblock %}

{% block extra_css %}
<style>
    .creator-header {
        background-color: var(--light-bg);
        border-radius: 0.5rem;
        padding: 2rem;
    }
    
    .creator-profile-pic {
        width: 160px;
        height: 160px;
        object-fit: cover;
        border-radius: 50%;
        border: 4px solid white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .creator-stats {
        background-color: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
    }
    
    .domain-badge {
        display: inline-block;
        padding: 0.35em 0.65em;
        border-radius: 0.25rem;
        background-color: var(--light-bg);
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .star-rating {
        color: var(--accent-color);
        font-size: 1.25rem;
    }
    
    .contact-item {
        display: flex;
        align-items: center;
        margin-bottom: 0.75rem;
    }
    
    .contact-item i {
        width: 24px;
        margin-right: 0.75rem;
        color: var(--primary-color);
    }
    
    .media-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
    }
    
    .media-item {
        border-radius: 0.5rem;
        overflow: hidden;
        aspect-ratio: 1/1;
        position: relative;
    }
    
    .media-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .media-item.video::after {
        content: '\f144';
        font-family: 'Font Awesome 5 Free';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 2rem;
        color: white;
        text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
    }
    
    .bio-section {
        border-left: 3px solid var(--primary-color);
        padding-left: 1rem;
        font-style: italic;
    }
    
    .rating-progress {
        height: 12px;
    }
    
    .rating-bar {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .rating-label {
        width: 50px;
    }
    
    .progress {
        flex: 1;
    }
    
    .rating-percent {
        width: 50px;
        text-align: right;
    }
    
    .video-container {
        border-radius: 0.5rem;
        overflow: hidden;
        position: relative;
        padding-top: 56.25%; /* 16:9 Aspect Ratio */
    }
    
    .video-container video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    
    #creator-map {
        height: 300px;
        width: 100%;
        border-radius: 0.5rem;
    }
    
    .verified-badge {
        position: absolute;
        top: 15px;
        right: 15px;
        background-color: var(--primary-color);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.8rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Section en-tête du créateur -->
<div class="creator-header position-relative mb-4">
    {% if creator.verified_by_neads %}
    <div class="verified-badge">
        <i class="fas fa-check-circle me-1"></i> Vérifié par NEADS
    </div>
    {% endif %}
    
    <div class="row align-items-center">
        <div class="col-md-3 text-center">
            {% if creator.media.filter.first %}
                {% with media=creator.media.filter.first %}
                    {% if media.file and media.file.name and media.file.url %}
                        <img src="{{ media.file.url }}" alt="{{ creator.full_name }}" class="creator-profile-pic mb-3">
                    {% else %}
                        <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center mx-auto creator-profile-pic mb-3">
                            {{ creator.first_name|first|upper }}{{ creator.last_name|first|upper }}
                        </div>
                    {% endif %}
                {% endwith %}
            {% else %}
                <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center mx-auto creator-profile-pic mb-3">
                    {{ creator.first_name|first|upper }}{{ creator.last_name|first|upper }}
                </div>
            {% endif %}
        </div>
        
        <div class="col-md-9">
            <h1 class="h2 mb-1">{{ creator.full_name }}</h1>
            <p class="text-muted mb-2">{{ creator.age }} ans, {{ creator.get_gender_display }}</p>
            
            <div class="d-flex flex-wrap mb-3">
                {% for domain in creator.domains.all %}
                    <span class="domain-badge">{{ domain.name }}</span>
                {% endfor %}
            </div>
            
            <div class="star-rating mb-2">
                {% for i in "12345" %}
                    {% if forloop.counter <= creator.average_rating %}
                        <i class="fas fa-star"></i>
                    {% elif forloop.counter <= creator.average_rating|add:0.5 %}
                        <i class="fas fa-star-half-alt"></i>
                    {% else %}
                        <i class="far fa-star"></i>
                    {% endif %}
                {% endfor %}
                <span class="ms-2 text-muted">({{ creator.average_rating }} - {{ creator.total_ratings }} avis)</span>
            </div>
            
            <div class="d-flex flex-wrap">
                {% if user.is_authenticated %}
                    <form method="post" action="{% url 'toggle_favorite' creator.id %}" class="me-2 mb-2">
                        {% csrf_token %}
                        {% if is_favorite %}
                            <input type="hidden" name="action" value="remove">
                            <button type="submit" class="btn btn-outline-danger">
                                <i class="fas fa-heart me-1"></i> Retirer des favoris
                            </button>
                        {% else %}
                            <button type="submit" class="btn btn-outline-primary">
                                <i class="far fa-heart me-1"></i> Ajouter aux favoris
                            </button>
                        {% endif %}
                    </form>
                {% endif %}
                
                <a href="#contact" class="btn btn-primary mb-2">
                    <i class="fas fa-envelope me-1"></i> Contacter
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Colonne principale -->
    <div class="col-lg-8">
        <!-- Section À propos -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-4">
                <h2 class="h4 mb-3">À propos</h2>
                
                {% if creator.bio %}
                    <div class="bio-section mb-4">
                        <p>{{ creator.bio }}</p>
                    </div>
                {% endif %}
                
                <div class="row">
                    <div class="col-md-6">
                        <h3 class="h5 mb-3">Setup & Professionnalisme</h3>
                        <ul class="list-unstyled">
                            {% if creator.equipment %}
                                <li class="mb-2">
                                    <i class="fas fa-camera me-2 text-primary"></i>
                                    Matériel : {{ creator.equipment }}
                                </li>
                            {% endif %}
                            
                            {% if creator.delivery_time %}
                                <li class="mb-2">
                                    <i class="fas fa-clock me-2 text-primary"></i>
                                    Délai de livraison : {{ creator.delivery_time }}
                                </li>
                            {% endif %}
                            
                            {% if creator.content_types %}
                                <li class="mb-2">
                                    <i class="fas fa-film me-2 text-primary"></i>
                                    Type de contenu : {{ creator.get_content_types_display }}
                                </li>
                            {% endif %}
                            
                            <li class="mb-2">
                                <i class="fas fa-car me-2 text-primary"></i>
                                Mobilité : {% if creator.mobility %}Oui (déplacements pris en charge){% else %}Non{% endif %}
                            </li>
                        </ul>
                    </div>
                    
                    <div class="col-md-6">
                        <h3 class="h5 mb-3">Facturation & Projets</h3>
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <i class="fas fa-file-invoice-dollar me-2 text-primary"></i>
                                Statut : {% if creator.can_invoice %}<span class="text-success">✓ Peut facturer</span>{% else %}<span class="text-danger">✗ Ne peut pas facturer</span>{% endif %}
                            </li>
                            
                            {% if creator.previous_clients %}
                                <li class="mb-2">
                                    <i class="fas fa-briefcase me-2 text-primary"></i>
                                    Clients précédents : {{ creator.previous_clients }}
                                </li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Section Portfolio - Images -->
        {% if images %}
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h2 class="h4 mb-3">Portfolio Images ({{ images|length }}/10)</h2>
                    
                    <div class="media-gallery">
                        {% for image in images %}
                            <div class="media-item">
                                <img src="{{ image.file.url }}" alt="{{ image.title|default:'Image' }}" loading="lazy">
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endif %}
        
        <!-- Section Portfolio - Vidéos -->
        {% if videos %}
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h2 class="h4 mb-3">Portfolio Vidéos ({{ videos|length }}/10)</h2>
                    
                    <div class="row">
                        {% for video in videos %}
                            <div class="col-md-6 mb-4">
                                <div class="video-container">
                                    <video controls preload="none" poster="{{ video.thumbnail.url }}">
                                        <source src="{{ video.video_file.url }}" type="video/mp4">
                                        Votre navigateur ne supporte pas la lecture vidéo.
                                    </video>
                                </div>
                                {% if video.title %}
                                    <p class="mt-2 mb-0">{{ video.title }}</p>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endif %}
        
        <!-- Section Avis & Notations -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-4">
                <h2 class="h4 mb-4">Avis & Notation</h2>
                
                <div class="row mb-4">
                    <div class="col-md-4 text-center">
                        <div class="h1 mb-0">{{ creator.average_rating }}</div>
                        <div class="star-rating mb-2">
                            {% for i in "12345" %}
                                {% if forloop.counter <= creator.average_rating %}
                                    <i class="fas fa-star"></i>
                                {% elif forloop.counter <= creator.average_rating|add:0.5 %}
                                    <i class="fas fa-star-half-alt"></i>
                                {% else %}
                                    <i class="far fa-star"></i>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <div class="text-muted">{{ creator.total_ratings }} avis</div>
                    </div>
                    
                    <div class="col-md-8">
                        <div class="rating-breakdown">
                            {% for rating, count in rating_breakdown.items reversed %}
                                <div class="rating-bar">
                                    <div class="rating-label">
                                        {{ rating }} <i class="fas fa-star small"></i>
                                    </div>
                                    <div class="progress rating-progress">
                                        {% if creator.total_ratings > 0 %}
                                            {% with percentage=count|floatformat:0|divisibleby:creator.total_ratings|floatformat:2|stringformat:"f"|slice:"2:-1" %}
                                                <div class="progress-bar bg-warning" role="progressbar" style="width: {{ percentage }}%" 
                                                    aria-valuenow="{{ percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
                                            {% endwith %}
                                        {% else %}
                                            <div class="progress-bar bg-warning" role="progressbar" style="width: 0%" 
                                                aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                        {% endif %}
                                    </div>
                                    <div class="rating-percent">
                                        {{ count }}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- Formulaire de notation -->
                {% if user.is_authenticated and user.has_role == 'consultant' or user.has_role == 'client' %}
                    <div class="card bg-light mb-4">
                        <div class="card-body">
                            <h3 class="h5 mb-3">{% if user_rating %}Modifier votre avis{% else %}Laisser un avis{% endif %}</h3>
                            
                            <form method="post" action="{% url 'rate_creator' creator.id %}">
                                {% csrf_token %}
                                
                                <div class="mb-3">
                                    <label class="form-label">Notation</label>
                                    <div class="d-flex">
                                        {% for choice in form.rating.field.choices %}
                                            <div class="form-check me-3">
                                                <input class="form-check-input" type="radio" name="rating" id="rating_{{ choice.0 }}" value="{{ choice.0 }}" 
                                                    {% if user_rating and user_rating.rating == choice.0 %}checked{% endif %}>
                                                <label class="form-check-label" for="rating_{{ choice.0 }}">
                                                    {{ choice.0 }} <i class="fas fa-star text-warning"></i>
                                                </label>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="{{ form.comment.id_for_label }}" class="form-label">Commentaire (facultatif)</label>
                                    {{ form.comment }}
                                </div>
                                
                                <div class="d-flex justify-content-end">
                                    <button type="submit" class="btn btn-primary">
                                        {% if user_rating %}Mettre à jour{% else %}Envoyer{% endif %}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                {% endif %}
                
                <!-- Affichage des avis -->
                {% if ratings %}
                    <h3 class="h5 mb-3">Avis des clients</h3>
                    
                    {% for rating in ratings %}
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <span class="fw-bold">{{ rating.user.get_full_name|default:rating.user.email }}</span>
                                        <span class="text-muted ms-2">{{ rating.created_at|date:"d/m/Y" }}</span>
                                    </div>
                                    <div class="star-rating">
                                        {% for i in "12345" %}
                                            {% if forloop.counter <= rating.rating %}
                                                <i class="fas fa-star"></i>
                                            {% else %}
                                                <i class="far fa-star"></i>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                                
                                {% if rating.comment %}
                                    <p class="mb-0">{{ rating.comment }}</p>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-light text-center">
                        Aucun avis pour le moment.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Colonne latérale -->
    <div class="col-lg-4">
        <!-- Section Coordonnées et contact -->
        <div class="card border-0 shadow-sm mb-4" id="contact">
            <div class="card-body p-4">
                <h2 class="h4 mb-3">Identité & Coordonnées</h2>
                
                {% if creator.location %}
                    <div class="contact-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>{{ creator.location }}</span>
                    </div>
                {% endif %}
                
                {% if user.is_authenticated and user.has_role == 'consultant' or user.has_role == 'admin' %}
                    <!-- Informations de contact visibles uniquement pour consultants/admins -->
                    <div class="contact-item">
                        <i class="fas fa-envelope"></i>
                        <span>{{ creator.email }}</span>
                    </div>
                    
                    {% if creator.phone %}
                        <div class="contact-item">
                            <i class="fas fa-phone"></i>
                            <span>{{ creator.phone }}</span>
                        </div>
                    {% endif %}
                    
                    <div class="d-grid gap-2 mt-3">
                        <a href="mailto:{{ creator.email }}" class="btn btn-primary">
                            <i class="fas fa-envelope me-1"></i> Contacter directement
                        </a>
                        <button class="btn btn-outline-primary" onclick="downloadVCard()">
                            <i class="fas fa-address-card me-1"></i> Télécharger VCard
                        </button>
                    </div>
                {% else %}
                    <!-- Pour les clients, formulaire de contact sécurisé -->
                    <p class="text-muted mb-3">
                        Pour contacter ce créateur, veuillez remplir le formulaire ci-dessous.
                        <br>Votre demande sera transmise de façon sécurisée.
                    </p>
                    
                    <form id="secure-contact-form">
                        <div class="mb-3">
                            <label class="form-label">Sujet</label>
                            <select class="form-select">
                                <option>Demande de collaboration</option>
                                <option>Question sur disponibilité</option>
                                <option>Demande de devis</option>
                                <option>Autre</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Message</label>
                            <textarea class="form-control" rows="4" placeholder="Votre message..."></textarea>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane me-1"></i> Envoyer
                            </button>
                        </div>
                    </form>
                {% endif %}
            </div>
        </div>
        
        <!-- Section Carte -->
        {% if creator.location and creator.location.latitude and creator.location.longitude %}
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h2 class="h4 mb-3">Localisation</h2>
                    <div id="creator-map"></div>
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if creator.location and creator.location.latitude and creator.location.longitude %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialisation de la carte Leaflet
        var map = L.map('creator-map').setView([{{ creator.location.latitude }}, {{ creator.location.longitude }}], 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // Marqueur pour le créateur
        L.marker([{{ creator.location.latitude }}, {{ creator.location.longitude }}])
            .addTo(map)
            .bindPopup('{{ creator.full_name }}');
    });
    
    // Fonction pour télécharger la VCard
    function downloadVCard() {
        // Code pour générer une VCard
        var vcard = 'BEGIN:VCARD\n';
        vcard += 'VERSION:3.0\n';
        vcard += 'FN:{{ creator.full_name }}\n';
        vcard += 'EMAIL:{{ creator.email }}\n';
        {% if creator.phone %}
        vcard += 'TEL:{{ creator.phone }}\n';
        {% endif %}
        {% if creator.location %}
        vcard += 'ADR:;;{{ creator.location }}\n';
        {% endif %}
        vcard += 'END:VCARD';
        
        // Création d'un élément <a> pour le téléchargement
        var element = document.createElement('a');
        element.setAttribute('href', 'data:text/vcard;charset=utf-8,' + encodeURIComponent(vcard));
        element.setAttribute('download', '{{ creator.full_name }}.vcf');
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
    }
</script>
{% endif %}
{% endblock %} 